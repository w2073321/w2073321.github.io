/**
 * sesdk-multilinktest-plugin.prod.js
 * An SDK for the SolarEngine intelligent marketing service platform
 * 多链接试验SDK插件接入文档: https://alidocs.dingtalk.com/i/nodes/QG53mjyd80RN35mAU5YMgjl9V6zbX04v
 * 版本号: 1.0.4
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).multilinktestPlugin=t()}(this,(function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e}).apply(this,arguments)}function t(e,t,i){var n=t.t0,o=t.t1,r=i||{},s={message:"多链接试验请求数据",state:5,code:r.code,error_message:r.msg,retry_count:r.retryCount,api_request_duration:o-n};e.trackLogEvent(s)}function i(e,t,i){var n;e.setStateData(((n={})["reportData.properties."+t]=i,n))}var n=["customIDProperties","customIDEventProperties","customIDUserProperties"];var o={addMask:function(e){var t,i,n=this,o="body{opacity:0 !important;-khtml-opacity:0 !important;-moz-opacity:0;filter:alpha(opacity=0);}",r=document.createElement("style");r.type="text/css";try{r.appendChild(document.createTextNode(o))}catch(e){r.styleSheet.cssText=o}this.styleElement=r,null==(t=document.getElementsByTagName("head"))||null==(i=t[0])||i.appendChild(r),this.removeMaskTimer=setTimeout((function(){n.removeMask()}),1e3*e)},removeMask:function(){var e,t;(clearTimeout(this.removeMaskTimer),this.styleElement)&&(null==(e=document.getElementsByTagName("head"))||null==(t=e[0])||t.removeChild(this.styleElement),this.styleElement=null)}},r={idProperties:{},serverConfig:[],eventProperties:{},userProperties:{}},s="_multilink_history";function u(u){u.extend({multilinkTest:{runtime:!0,init:function(e){this.initRemoteConfig(e),r.idProperties=function(e,t){var i={};return n.forEach((function(n){e.isObject(t[n])&&(i[n]=e.filterCustomProperties(t[n]))})),i}(u,e),this.initReportData(),this.getOnlineConfig()},initRemoteConfig:function(e){r.maskTimeoutCloseTime=u.settingData.maskTimeoutCloseTime,"number"==typeof(null==e?void 0:e.maskTimeoutCloseTime)&&e.maskTimeoutCloseTime/1e3>u.settingData.minMaskTimeoutCloseTime&&(r.maskTimeoutCloseTime=e.maskTimeoutCloseTime/1e3),(null==e?void 0:e.isSetMask)&&o.addMask(r.maskTimeoutCloseTime)},initReportData:function(){i(u,"_custom_id",r.idProperties.customIDProperties),i(u,"_event_custom_id",r.idProperties.customIDEventProperties),i(u,"_user_custom_id",r.idProperties.customIDUserProperties)},getOnlineConfig:function(t){var i=this;void 0===t&&(t={});var n=u.deepCopy(u.getStateData("reportData")||{}),o=u.deepCopy(n.properties);delete n.properties,delete n._package_type,delete o._combination_id,delete o._experiment_group_id_list,delete o._group_id_list;var a=e({},n,o,{event_properties:e({},r.eventProperties),user_properties:e({},r.userProperties),_custom_id:r.idProperties.customIDProperties,_event_custom_id:r.idProperties.customIDEventProperties,_user_custom_id:r.idProperties.customIDUserProperties,experiment_history:u.Storage.getItem(s,!0,[])});return t.t0=+new Date,new Promise((function(e){i.requestRetry(e,a,t)}))},requestRetry:function(e,i,n,r){var s=this;void 0===r&&(r=u.settingData.multilinkRetryTimes),u.HttpHelper.post("//"+u.settingData.ruleDomain+"/rule/config/multilink/get",i,{timeout:1e3*u.settingData.multilinkTimeout}).then((function(e){n.t1=+new Date,0===(null==e?void 0:e.code)&&s.handleServerConfig((null==e?void 0:e.data)||{}),o.removeMask();var i={retryCount:3-r,code:null==e?void 0:e.code,msg:null==e?void 0:e.msg};t(u,n,i)})).catch((function(a){if(r>0)r--,s.requestRetry(e,i,n,r);else{n.t1=+new Date,o.removeMask(),u.customEvents.$emit("multilinkTest");var l={retryCount:u.settingData.multilinkRetryTimes-r,code:(null==a?void 0:a.code)||"timeout",msg:(null==a?void 0:a.msg)||a};t(u,n,l)}}))},handleServerConfig:function(e){var t,i,n,o,r,a,l,m=e.params||[],d=u.trimStr((null==(t=m[0])?void 0:t.url)||""),c=!(null==m?void 0:m.length)||!d,p=d===location.href;if((c||p)&&u.customEvents.$emit("multilinkTest"),!c){var v={url:d,subjectId:null==(i=m[0])?void 0:i.subject_id,entityId:null==(n=m[0])?void 0:n.entity_id,groupId:null==(o=m[0])?void 0:o.group_id,status:null==(r=m[0])?void 0:r.status,subjectName:null==(a=m[0])?void 0:a.subject_name,subjectValue:null==(l=m[0])?void 0:l.subject_value},g=function(e,t){var i=e.getStateData("reportData");if(i._appkey&&t.subjectName&&t.subjectValue&&t.entityId&&t.groupId){var n=i._appkey+"_"+t.subjectName+"_"+t.subjectValue+"_"+t.entityId+"_"+t.groupId;if(e.Storage.getItem(n))return!0;e.Storage.setItem(n,1)}return!1}(u,v);g||this.trackTriageEvents(v),u.Storage.setItem(s,m.map((function(e){return{entity_id:e.entity_id,group_id:e.group_id}}))),p||setTimeout((function(){location.href=v.url}),g?0:1e3*u.settingData.multilinkJumpWaitSendEvent)}},trackTriageEvents:function(e){var t={_experiment_id:e.groupId,_experiment_group_id:e.entityId,_experiment_status:e.status};u.trackEvent("_abtesting_shunt",t,{},{_event_type:2})}}})}return{env:"web",init:function(e){if(!(null==e?void 0:e.NATIVE)||"function"!=typeof(null==e?void 0:e.extend))return console.error("The plugin cannot be used alone, it depends on the webSDK.");u(e),function(e){e.NATIVE=Object.assign(e.NATIVE,{setMultilinkTestEventProperties:function(t){if(e.getStateData("logEnabled")&&e.infoLog("setMultilinkTestEventProperties",t),!e.isObject(t))return e.assert(!1,440120);r.eventProperties=Object.assign(r.eventProperties,t)},setMultilinkTestUserProperties:function(t){if(e.getStateData("logEnabled")&&e.infoLog("setMultilinkTestUserProperties",t),!e.isObject(t))return e.assert(!1,440120);r.userProperties=Object.assign(r.userProperties,t)}})}(e)}}}));
