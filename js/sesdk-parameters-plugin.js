/**
 * sesdk-parameters-plugin.prod.js
 * An SDK for the SolarEngine intelligent marketing service platform
 * 参数下发SDK插件接入文档: https://help.solar-engine.com/cn/docs/MoaZAQ
 * 版本号: 1.0.4
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).parametersPlugin=t()}(this,(function(){"use strict";function e(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function t(e,t,r){var n;e.setStateData(((n={})["reportData.properties."+t]=r,n))}var r=["customIDProperties","customIDEventProperties","customIDUserProperties"];function n(e,t){return e.isValueExceedLimit(e.valueToStr(t))?(t.shift(),n(e.config)):t}function i(e,t,r,n,o){e.Storage.setItem(t,r.slice(n[o]),(function(){o<n.length-1?i(e,t,r,n,o+1):e.Storage.deleteItem(storageKey.combinationId)}))}function o(e,t,r,o){if(!Array.isArray(r))return[];var a=n(e,r.slice(0));i(e,t,a,function(e,t){var r=e-t,n=[],i=Math.ceil(r/10);if(r>0)for(var o=r;o>0;o-=i)n.unshift(o);return n.unshift(0),n}(a.length,o),0)}function a(e,t){var r,n,i,o,a,u,s,f=e.filter((function(e){return e.name===t}));return f.length?{value:null==(r=f[0])?void 0:r.value,groupId:null==(n=f[0])?void 0:n.group_id,status:null==(i=f[0])?void 0:i.status,from:null==(o=f[0])?void 0:o.from,entityId:null==(a=f[0])?void 0:a.entity_id,subjectName:null==(u=f[0])?void 0:u.subject_name,subjectValue:null==(s=f[0])?void 0:s.subject_value}:null}function u(e,r){var n=e.Storage.getItem(r,!0,[]);t(e,r,(null==n?void 0:n.length)?n:null)}function s(e,r,n,i){void 0===i&&(i=1);var o=function(e,t){if(void 0===t&&(t=1),!Array.isArray(e))return[];var r=e.filter((function(e){return e.from===t})).map((function(e){return e.entity_id}));return Array.from(new Set(r))}(r,i);t(e,n,o),e.Storage.setItem(n,o)}function f(e,t,r){e.t3=+new Date,e.param_value=t&&void 0!==t.value?t.value:null;var n,i=0;("number"==typeof(null==t?void 0:t.param_from)&&(i=t.param_from),3!==i)&&((null==r||null==(n=r.filter((function(t){return t.name===e.param_key})))?void 0:n.length)&&(i=1));return e.param_from=i,e}function l(e,t,r){var n=t.t0,i=t.t1,o=t.t2,a=t.t3,u={message:"在线参数请求数据",state:1,api_total_duration:a-n,retry_count:-1,param_key:t.param_key,param_value:t.param_value,param_from:t.param_from};if(r){var s=r||{},f=s.code,l=s.msg,c=s.retryCount;u.code=f,u.error_message=l,u.retry_count=c,u.builld_request_body_duration=i-n,u.api_request_duration=o-i,u.data_process_duration=a-o}e.trackLogEvent(u)}var c={intervalTimer:null,mergeType:0,idProperties:{},defaultConfig:[],serverConfig:[],currentServerConfig:[],combinationId:"",eventProperties:{},userProperties:{}},g="_default_config",m="_serevr_config",p="_combination_id",d="_group_id_list",v="_experiment_group_id_list",_="_experiment_history";function y(n){n.extend({parameters:{init:function(e){c.mergeType=e.mergeType||0,c.idProperties=function(e,t){var n={};return r.forEach((function(r){e.isObject(t[r])&&(n[r]=e.filterCustomProperties(t[r]))})),n}(n,e),c.defaultConfig=n.Storage.getItem(g,!0,[]),this.checkCacheConfig(),this.initReportData(),this.getOnlineConfig(!0)},initReportData:function(){t(n,p,n.Storage.getItem(p)||null),u(n,d),u(n,v),t(n,"_custom_id",c.idProperties.customIDProperties),t(n,"_event_custom_id",c.idProperties.customIDEventProperties),t(n,"_user_custom_id",c.idProperties.customIDUserProperties)},checkCacheConfig:function(){var e;c.combinationId=n.Storage.getItem(p)||"",c.serverConfig=n.Storage.getItem(m,!0,[]),c.combinationId&&!(null==(e=c.serverConfig)?void 0:e.length)&&(c.combinationId="",n.Storage.deleteItem(p))},getOnlineConfig:function(t,r){var i=this;void 0===r&&(r={}),this.checkCacheConfig();var o=n.deepCopy(n.getStateData("reportData")||{}),a=n.deepCopy(o.properties);delete o.properties,delete o._package_type;var u=e({},o,a,{_combination_id:t&&1===c.mergeType?"":c.combinationId,event_properties:e({},c.eventProperties),user_properties:e({},c.userProperties),_custom_id:c.idProperties.customIDProperties,_event_custom_id:c.idProperties.customIDEventProperties,_user_custom_id:c.idProperties.customIDUserProperties,experiment_history:n.Storage.getItem(_,!0,[])});return r.t1=+new Date,new Promise((function(e){i.requestRetry(e,u,t,r)}))},requestRetry:function(e,t,r,i,o){var a=this;void 0===o&&(o=n.settingData.ruleRetryTimes),n.HttpHelper.post("//"+n.settingData.ruleDomain+"/rule/config/get",t,{timeout:1e3*n.settingData.ruleTimeout}).then((function(t){i.t2=+new Date,0===(null==t?void 0:t.code)&&a.handleServerConfig((null==t?void 0:t.data)||{},r),e({retryCount:3-o,code:null==t?void 0:t.code,msg:null==t?void 0:t.msg}),a.setTimer()})).catch((function(u){o>0?(o--,a.requestRetry(e,t,r,i,o)):(a.setTimer(),e({retryCount:n.settingData.ruleRetryTimes-o,code:(null==u?void 0:u.code)||"timeout",msg:(null==u?void 0:u.msg)||u}))}))},setTimer:function(){var e=this;clearTimeout(c.intervalTimer),c.intervalTimer=setTimeout((function(){return e.getOnlineConfig()}),1e3*n.settingData.ruleInterval)},handleServerConfig:function(e,r){var i,a=e.params||[],u=null==e?void 0:e._combination_id,f=(null==(i=a)?void 0:i.length)||0;c.currentServerConfig=a,u&&(c.combinationId=u,n.Storage.setItem(p,u),t(n,p,u)),u&&f&&(s(n,a,d),s(n,a,v,2),n.Storage.setItem(_,a.filter((function(e){return 2===e.from})).map((function(e){return{entity_id:e.entity_id,group_id:e.group_id}}))),0!==c.mergeType&&r||(a=function(e,t){return(null==t?void 0:t.length)?t.filter((function(t){return e.findIndex((function(e){return e.name===t.name}))<0})).concat(e):e}(a,c.serverConfig)),c.serverConfig=a,o(n,m,a,f))},getConfigByKey:function(e){var t=a(c.serverConfig,e);return null===t?(t=a(c.defaultConfig,e),n.isObject(t)&&(t.param_from=3)):t.param_from=2,t},trackTriageEvents:function(e){if(!function(e,t){var r=e.getStateData("reportData");if(r._appkey&&t.subjectName&&t.subjectValue&&t.entityId&&t.groupId){var n=r._appkey+"_"+t.subjectName+"_"+t.subjectValue+"_"+t.entityId+"_"+t.groupId;if(e.Storage.getItem(n))return!0;e.Storage.setItem(n,1)}return!1}(n,e))if(1===e.from){var t={_enter_group_id:e.entityId,_enter_group_status:e.status};n.trackEvent("_diversion_service",t,{},{_event_type:2})}else{var r={_experiment_id:e.groupId,_experiment_group_id:e.entityId,_experiment_status:e.status};n.trackEvent("_abtesting_shunt",r,{},{_event_type:2})}}}})}return{init:function(e){if(!(null==e?void 0:e.NATIVE)||"function"!=typeof(null==e?void 0:e.extend))return console.error("Plugin can not be used alone, you need to rely on the webSDK or WeChat small program SDK");y(e),function(e){e.NATIVE=Object.assign(e.NATIVE,{setRemoteDefaultConfig:function(t){if(e.getStateData("logEnabled")&&e.infoLog("setRemoteDefaultConfig",t),!Array.isArray(t))return e.assert(!1,440103);c.defaultConfig=t,e.Storage.setItem(g,t)},setRemoteConfigEventProperties:function(t){if(e.getStateData("logEnabled")&&e.infoLog("setRemoteConfigEventProperties",t),!e.isObject(t))return e.assert(!1,440120);c.eventProperties=Object.assign(c.eventProperties,t)},setRemoteConfigUserProperties:function(t){if(e.getStateData("logEnabled")&&e.infoLog("setRemoteConfigUserProperties",t),!e.isObject(t))return e.assert(!1,440120);c.userProperties=Object.assign(c.userProperties,t)},fastFetchRemoteConfig:function(t){if(e.getStateData("logEnabled")&&e.infoLog("fastFetchRemoteConfig",t),!t||"string"!=typeof t||!e.trimStr(t))return e.assert(!1,440105);var r={t0:+new Date,param_key:t},n=e.parameters.getConfigByKey(t),i=null;return n&&void 0!==n.value&&(n.groupId&&e.parameters.trackTriageEvents(n),i=n.value),l(e,f(r,n,c.currentServerConfig)),i},asyncFetchRemoteConfig:function(t){if(e.getStateData("logEnabled")&&e.infoLog("asyncFetchRemoteConfig",t),!t||"string"!=typeof t||!e.trimStr(t))return e.assert(!1,440105);var r={t0:+new Date,param_key:t};return new Promise((function(n){e.NATIVE.ready((function(){e.parameters.getOnlineConfig(!1,r).then((function(i){var o=e.parameters.getConfigByKey(t),a=null;o&&void 0!==o.value&&(o.groupId&&e.parameters.trackTriageEvents(o),a=o.value),n(a),l(e,f(r,o,c.currentServerConfig),i)}))}))}))}})}(e)}}}));
